---
import Layout from '../../layouts/Layout.astro';
import { Icon } from 'astro-icon/components';

// Enable server-side rendering for dynamic routes
export const prerender = false;

const { username } = Astro.params;
---

<Layout title={`${username} - Profile | GitGoPR`}>
  <div class="min-h-screen bg-gradient-to-br from-black via-gray-900 to-green-900">
    <!-- Back Button -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-8">
      <a 
        href="/leaderboard"
        class="inline-flex items-center gap-2 text-green-400 hover:text-green-300 transition-colors font-mono"
      >
        <Icon name="heroicons:arrow-left" class="w-5 h-5" />
        Back to Leaderboard
      </a>
    </div>

    <!-- Loading State -->
    <div id="loading" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
      <div class="space-y-8">
        <!-- Header Skeleton -->
        <div class="skeleton-shimmer bg-gradient-to-br from-gray-900/80 to-gray-800/80 backdrop-blur-sm rounded-2xl p-8 border border-gray-700 shadow-2xl">
          <div class="flex flex-col md:flex-row items-start md:items-center gap-6">
            <div class="w-24 h-24 rounded-full bg-gray-700/50 border-4 border-gray-600"></div>
            <div class="flex-1 space-y-3 w-full">
              <div class="h-8 bg-gray-700/50 rounded w-48"></div>
              <div class="h-5 bg-gray-700/50 rounded w-32"></div>
              <div class="h-4 bg-gray-700/50 rounded w-full max-w-md"></div>
              <div class="flex flex-wrap gap-4 mt-3">
                <div class="h-4 bg-gray-700/50 rounded w-24"></div>
                <div class="h-4 bg-gray-700/50 rounded w-28"></div>
                <div class="h-4 bg-gray-700/50 rounded w-32"></div>
              </div>
            </div>
            <div class="h-12 bg-gray-700/50 rounded-xl w-48"></div>
          </div>
        </div>
        
        <!-- Stats Skeleton -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="skeleton-shimmer bg-gradient-to-br from-gray-800/60 to-gray-700/60 backdrop-blur-sm rounded-xl p-6 border border-gray-600">
            <div class="h-9 bg-gray-700/50 rounded w-16 mb-2"></div>
            <div class="h-4 bg-gray-700/50 rounded w-24"></div>
          </div>
          <div class="skeleton-shimmer bg-gradient-to-br from-gray-800/60 to-gray-700/60 backdrop-blur-sm rounded-xl p-6 border border-gray-600" style="animation-delay: 0.1s">
            <div class="h-9 bg-gray-700/50 rounded w-16 mb-2"></div>
            <div class="h-4 bg-gray-700/50 rounded w-28"></div>
          </div>
          <div class="skeleton-shimmer bg-gradient-to-br from-gray-800/60 to-gray-700/60 backdrop-blur-sm rounded-xl p-6 border border-gray-600" style="animation-delay: 0.2s">
            <div class="h-9 bg-gray-700/50 rounded w-16 mb-2"></div>
            <div class="h-4 bg-gray-700/50 rounded w-24"></div>
          </div>
          <div class="skeleton-shimmer bg-gradient-to-br from-gray-800/60 to-gray-700/60 backdrop-blur-sm rounded-xl p-6 border border-gray-600" style="animation-delay: 0.3s">
            <div class="h-9 bg-gray-700/50 rounded w-16 mb-2"></div>
            <div class="h-4 bg-gray-700/50 rounded w-24"></div>
          </div>
        </div>
        
        <!-- Content Skeleton -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <div class="lg:col-span-2 space-y-8">
            <!-- Activity Graph Skeleton -->
            <div class="skeleton-shimmer bg-gradient-to-br from-gray-900/80 to-gray-800/80 backdrop-blur-sm rounded-2xl p-6 border border-gray-700">
              <div class="flex items-center gap-2 mb-4">
                <div class="w-6 h-6 bg-gray-700/50 rounded"></div>
                <div class="h-6 bg-gray-700/50 rounded w-40"></div>
              </div>
              <div class="h-64 bg-gray-700/30 rounded-xl border border-gray-700"></div>
            </div>
            
            <!-- Pull Requests Skeleton -->
            <div class="skeleton-shimmer bg-gradient-to-br from-gray-900/80 to-gray-800/80 backdrop-blur-sm rounded-2xl p-6 border border-gray-700">
              <div class="flex items-center gap-2 mb-4">
                <div class="w-6 h-6 bg-gray-700/50 rounded"></div>
                <div class="h-6 bg-gray-700/50 rounded w-32"></div>
              </div>
              <div class="space-y-3">
                <div class="bg-gray-800/50 rounded-lg p-4 border border-gray-700">
                  <div class="h-4 bg-gray-700/50 rounded w-3/4 mb-2"></div>
                  <div class="h-3 bg-gray-700/50 rounded w-1/2"></div>
                </div>
                <div class="bg-gray-800/50 rounded-lg p-4 border border-gray-700">
                  <div class="h-4 bg-gray-700/50 rounded w-2/3 mb-2"></div>
                  <div class="h-3 bg-gray-700/50 rounded w-1/3"></div>
                </div>
                <div class="bg-gray-800/50 rounded-lg p-4 border border-gray-700">
                  <div class="h-4 bg-gray-700/50 rounded w-4/5 mb-2"></div>
                  <div class="h-3 bg-gray-700/50 rounded w-2/5"></div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="space-y-8">
            <!-- Top Languages Skeleton -->
            <div class="skeleton-shimmer bg-gradient-to-br from-gray-900/80 to-gray-800/80 backdrop-blur-sm rounded-2xl p-6 border border-gray-700">
              <div class="flex items-center gap-2 mb-4">
                <div class="w-6 h-6 bg-gray-700/50 rounded"></div>
                <div class="h-6 bg-gray-700/50 rounded w-36"></div>
              </div>
              <div class="space-y-3">
                <div>
                  <div class="flex justify-between mb-1">
                    <div class="h-4 bg-gray-700/50 rounded w-20"></div>
                    <div class="h-4 bg-gray-700/50 rounded w-12"></div>
                  </div>
                  <div class="h-2 bg-gray-700/50 rounded-full"></div>
                </div>
                <div>
                  <div class="flex justify-between mb-1">
                    <div class="h-4 bg-gray-700/50 rounded w-24"></div>
                    <div class="h-4 bg-gray-700/50 rounded w-12"></div>
                  </div>
                  <div class="h-2 bg-gray-700/50 rounded-full"></div>
                </div>
                <div>
                  <div class="flex justify-between mb-1">
                    <div class="h-4 bg-gray-700/50 rounded w-16"></div>
                    <div class="h-4 bg-gray-700/50 rounded w-12"></div>
                  </div>
                  <div class="h-2 bg-gray-700/50 rounded-full"></div>
                </div>
              </div>
            </div>
            
            <!-- Organizations Skeleton -->
            <div class="skeleton-shimmer bg-gradient-to-br from-gray-900/80 to-gray-800/80 backdrop-blur-sm rounded-2xl p-6 border border-gray-700">
              <div class="flex items-center gap-2 mb-4">
                <div class="w-6 h-6 bg-gray-700/50 rounded"></div>
                <div class="h-6 bg-gray-700/50 rounded w-32"></div>
              </div>
              <div class="space-y-2">
                <div class="flex items-center gap-3 bg-gray-800/50 rounded-lg p-3 border border-gray-700">
                  <div class="w-10 h-10 rounded-full bg-gray-700/50"></div>
                  <div class="flex-1">
                    <div class="h-4 bg-gray-700/50 rounded w-24 mb-1"></div>
                    <div class="h-3 bg-gray-700/50 rounded w-20"></div>
                  </div>
                </div>
                <div class="flex items-center gap-3 bg-gray-800/50 rounded-lg p-3 border border-gray-700">
                  <div class="w-10 h-10 rounded-full bg-gray-700/50"></div>
                  <div class="flex-1">
                    <div class="h-4 bg-gray-700/50 rounded w-28 mb-1"></div>
                    <div class="h-3 bg-gray-700/50 rounded w-20"></div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Top Repositories Skeleton -->
            <div class="skeleton-shimmer bg-gradient-to-br from-gray-900/80 to-gray-800/80 backdrop-blur-sm rounded-2xl p-6 border border-gray-700">
              <div class="flex items-center gap-2 mb-4">
                <div class="w-6 h-6 bg-gray-700/50 rounded"></div>
                <div class="h-6 bg-gray-700/50 rounded w-40"></div>
              </div>
              <div class="space-y-2">
                <div class="bg-gray-800/50 rounded-lg p-4 border border-gray-700">
                  <div class="h-4 bg-gray-700/50 rounded w-3/4 mb-3"></div>
                  <div class="flex items-center gap-3">
                    <div class="h-3 bg-gray-700/50 rounded w-12"></div>
                    <div class="h-3 bg-gray-700/50 rounded w-12"></div>
                    <div class="h-3 bg-gray-700/50 rounded w-16"></div>
                  </div>
                </div>
                <div class="bg-gray-800/50 rounded-lg p-4 border border-gray-700">
                  <div class="h-4 bg-gray-700/50 rounded w-2/3 mb-3"></div>
                  <div class="flex items-center gap-3">
                    <div class="h-3 bg-gray-700/50 rounded w-12"></div>
                    <div class="h-3 bg-gray-700/50 rounded w-12"></div>
                    <div class="h-3 bg-gray-700/50 rounded w-20"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Error State -->
    <div id="error" class="hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
      <div class="bg-red-900/20 border border-red-500/50 rounded-xl p-6 backdrop-blur-sm">
        <h2 class="text-red-400 text-xl font-bold font-mono mb-2">Error Loading Profile</h2>
        <p id="error-message" class="text-red-300 font-mono"></p>
      </div>
    </div>

    <!-- Profile Content -->
    <div id="profile-content" class="hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
      <!-- Profile Header -->
      <div class="bg-gradient-to-br from-gray-900/80 to-gray-800/80 backdrop-blur-sm rounded-2xl p-8 border border-gray-700 shadow-2xl mb-8">
        <div class="flex flex-col md:flex-row items-start md:items-center gap-6">
          <img 
            id="avatar" 
            class="w-24 h-24 rounded-full border-4 border-green-500 shadow-xl ring-4 ring-green-500/30"
            alt="User avatar"
          />
          <div class="flex-1">
            <h1 id="display-name" class="text-3xl font-bold text-white font-mono mb-2"></h1>
            <p id="username-display" class="text-green-400 font-mono text-lg mb-2"></p>
            <p id="bio" class="text-gray-300 font-mono hidden"></p>
            <div id="user-meta" class="flex flex-wrap gap-4 mt-3"></div>
          </div>
          <a 
            id="github-link"
            href="#"
            target="_blank"
            class="inline-flex items-center gap-2 bg-gradient-to-r from-green-500 to-lime-400 text-black px-6 py-3 rounded-xl hover:from-green-600 hover:to-lime-500 transition-all font-bold font-mono shadow-xl"
          >
            <Icon name="mdi:github" class="w-5 h-5" />
            View on GitHub
          </a>
        </div>
      </div>

      <!-- Stats Grid -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8" id="stats-grid">
        <!-- Stats will be inserted here -->
      </div>

      <!-- Main Content Grid -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Left Column - Contribution Graph & Languages -->
        <div class="lg:col-span-2 space-y-8">
          <!-- Activity Graph (GitHub Readme Activity Graph) -->
          <div class="bg-gradient-to-br from-gray-900/80 to-gray-800/80 backdrop-blur-sm rounded-2xl p-6 border border-gray-700">
            <h2 class="text-xl font-bold text-white font-mono mb-4 flex items-center gap-2">
              <Icon name="heroicons:chart-bar-square" class="w-6 h-6 text-green-400" />
              Activity Graph
            </h2>
            <div id="activity-graph" class="rounded-xl overflow-hidden border border-gray-700">
              <!-- Activity graph image will be injected here -->
              <div class="p-6 text-center text-gray-400 font-mono" id="activity-graph-loading">Loading activity graph...</div>
            </div>
          </div>

          <!-- Pull Requests List -->
          <div class="bg-gradient-to-br from-gray-900/80 to-gray-800/80 backdrop-blur-sm rounded-2xl p-6 border border-gray-700">
            <h2 class="text-xl font-bold text-white font-mono mb-4 flex items-center gap-2">
              <Icon name="heroicons:code-bracket" class="w-6 h-6 text-green-400" />
              Pull Requests
            </h2>
            <div id="pr-list" class="space-y-3 max-h-96 overflow-y-auto">
              <!-- PRs will be inserted here -->
            </div>
          </div>
        </div>

        <!-- Right Column - Languages & Organizations -->
        <div class="space-y-8">
          <!-- Top Languages -->
          <div class="bg-gradient-to-br from-gray-900/80 to-gray-800/80 backdrop-blur-sm rounded-2xl p-6 border border-gray-700">
            <h2 class="text-xl font-bold text-white font-mono mb-4 flex items-center gap-2">
              <Icon name="heroicons:code-bracket-square" class="w-6 h-6 text-green-400" />
              Top Languages
            </h2>
            <div id="languages-chart" class="space-y-3">
              <!-- Languages will be inserted here -->
            </div>
          </div>

          <!-- Organizations -->
          <div class="bg-gradient-to-br from-gray-900/80 to-gray-800/80 backdrop-blur-sm rounded-2xl p-6 border border-gray-700">
            <h2 class="text-xl font-bold text-white font-mono mb-4 flex items-center gap-2">
              <Icon name="heroicons:building-office" class="w-6 h-6 text-green-400" />
              Organizations
            </h2>
            <div id="organizations-list" class="space-y-2">
              <!-- Organizations will be inserted here -->
            </div>
          </div>

          <!-- Top Repositories -->
          <div class="bg-gradient-to-br from-gray-900/80 to-gray-800/80 backdrop-blur-sm rounded-2xl p-6 border border-gray-700">
            <h2 class="text-xl font-bold text-white font-mono mb-4 flex items-center gap-2">
              <Icon name="heroicons:star" class="w-6 h-6 text-green-400" />
              Top Repositories
            </h2>
            <div id="repositories-list" class="space-y-2 max-h-96 overflow-y-auto">
              <!-- Repositories will be inserted here -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<!-- Pass username as data attribute -->
<div id="profile-data" data-username={username} style="display: none;"></div>

<script>
  const profileData = document.getElementById('profile-data');
  const username = profileData?.dataset.username;
  const API_BASE = import.meta.env.PUBLIC_API_BASE_URL || 'http://localhost:4000';
  const GITHUB_API = 'https://api.github.com';

  async function loadProfile() {
    try {
      // Try backend API first (has cached data)
      let data;
      try {
        const backendResponse = await fetch(`${API_BASE}/user/${username}`);
        if (backendResponse.ok) {
          data = await backendResponse.json();
        }
      } catch (backendError) {
        console.log('Backend not available, fetching from GitHub API');
      }

      // If backend fails, fetch from GitHub API directly
      if (!data) {
        // Fetch user data
        const userResponse = await fetch(`${GITHUB_API}/users/${username}`);
        if (!userResponse.ok) {
          throw new Error('User not found on GitHub');
        }
        const githubUser = await userResponse.json();

        // Fetch repos
        const reposResponse = await fetch(`${GITHUB_API}/users/${username}/repos?sort=updated&per_page=100`);
        const repos = await reposResponse.json();

        // Fetch organizations
        const orgsResponse = await fetch(`${GITHUB_API}/users/${username}/orgs`);
        const orgs = await orgsResponse.json();

        // Fetch events (for PR data)
        const eventsResponse = await fetch(`${GITHUB_API}/users/${username}/events?per_page=100`);
        const events = await eventsResponse.json();

        // Calculate statistics
        const totalStars = repos.reduce((sum, repo) => sum + (repo.stargazers_count || 0), 0);
        const totalForks = repos.reduce((sum, repo) => sum + (repo.forks_count || 0), 0);
        
        // Count PRs from events
        const prEvents = events.filter(e => e.type === 'PullRequestEvent');
        const totalPRs = prEvents.length;
        
        // Extract languages
        const languageMap = {};
        repos.forEach(repo => {
          if (repo.language) {
            languageMap[repo.language] = (languageMap[repo.language] || 0) + 1;
          }
        });
        const topLanguages = Object.entries(languageMap)
          .map(([name, count]) => ({ name, count }))
          .sort((a, b) => b.count - a.count)
          .slice(0, 5);

        // Build data object matching our format
        data = {
          username: githubUser.login,
          displayName: githubUser.name || githubUser.login,
          fullName: githubUser.name,
          avatarUrl: githubUser.avatar_url,
          bio: githubUser.bio,
          location: githubUser.location,
          company: githubUser.company,
          blog: githubUser.blog,
          followers: githubUser.followers,
          following: githubUser.following,
          publicRepos: githubUser.public_repos,
          totalPRs: totalPRs,
          mergedPRs: Math.floor(totalPRs * 0.8), // Estimate
          totalStars: totalStars,
          totalForks: totalForks,
          currentStreak: 0,
          reposContributedTo: repos.length,
          organizations: orgs.map(org => org.login),
          topLanguages: topLanguages,
          contributionHistory: [],
          prs: prEvents.slice(0, 20).map(event => ({
            id: event.id,
            title: event.payload?.pull_request?.title || 'Pull Request',
            repo: event.repo.name,
            status: event.payload?.action === 'closed' ? 'merged' : 'open',
            created_at: event.created_at,
            html_url: event.payload?.pull_request?.html_url || `https://github.com/${event.repo.name}`,
            language: null
          })),
          topRepositories: repos.slice(0, 10).map(repo => ({
            name: repo.full_name,
            stars: repo.stargazers_count,
            forks: repo.forks_count,
            issues: repo.open_issues_count,
            language: repo.language
          }))
        };
      }
      
      // Hide loading, show content
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('profile-content').classList.remove('hidden');

      // Populate header
      document.getElementById('avatar').src = data.avatarUrl;
      document.getElementById('display-name').textContent = data.displayName || data.username;
      document.getElementById('username-display').textContent = `@${data.username}`;
      document.getElementById('github-link').href = `https://github.com/${data.username}`;

      if (data.bio) {
        const bioEl = document.getElementById('bio');
        bioEl.textContent = data.bio;
        bioEl.classList.remove('hidden');
      }

      // User meta
      const userMeta = document.getElementById('user-meta');
      const metaItems = [];
      
      if (data.location) {
        metaItems.push(`
          <span class="flex items-center gap-1.5 text-gray-400 text-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            ${data.location}
          </span>
        `);
      }
      if (data.company) {
        metaItems.push(`
          <span class="flex items-center gap-1.5 text-gray-400 text-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
            </svg>
            ${data.company}
          </span>
        `);
      }
      if (data.college) {
        metaItems.push(`
          <span class="flex items-center gap-1.5 text-gray-400 text-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path d="M12 14l9-5-9-5-9 5 9 5z" />
              <path d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5zm0 0l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14zm-4 6v-7.5l4-2.222" />
            </svg>
            ${data.college}
          </span>
        `);
      }
      if (data.role) {
        metaItems.push(`
          <span class="flex items-center gap-1.5 text-gray-400 text-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
            ${data.role}
          </span>
        `);
      }
      if (data.followers !== undefined) {
        metaItems.push(`
          <span class="flex items-center gap-1.5 text-gray-400 text-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
            ${data.followers} followers
          </span>
        `);
      }
      if (data.following !== undefined) {
        metaItems.push(`
          <span class="flex items-center gap-1.5 text-gray-400 text-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
            </svg>
            ${data.following} following
          </span>
        `);
      }
      if (data.blog) {
        metaItems.push(`
          <a href="${data.blog.startsWith('http') ? data.blog : 'https://' + data.blog}" target="_blank" class="flex items-center gap-1.5 text-gray-400 hover:text-green-400 transition-colors text-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
            </svg>
            ${data.blog.replace(/^https?:\/\//, '')}
          </a>
        `);
      }
      
      userMeta.innerHTML = metaItems.join('');

      // Stats grid
      const statsGrid = document.getElementById('stats-grid');
      const stats = [
        { label: 'Total PRs', value: data.totalPRs || 0, icon: 'heroicons:document-text', color: 'blue' },
        { label: 'Public Repos', value: data.publicRepos || data.reposContributedTo || 0, icon: 'heroicons:folder', color: 'purple' },
        { label: 'Total Stars', value: data.totalStars || 0, icon: 'heroicons:star', color: 'yellow' },
        { label: 'Total Forks', value: data.totalForks || 0, icon: 'heroicons:code-bracket', color: 'green' }
      ];

      statsGrid.innerHTML = stats.map(stat => `
        <div class="bg-gradient-to-br from-gray-800/60 to-gray-700/60 backdrop-blur-sm rounded-xl p-6 border border-gray-600">
          <div class="text-${stat.color}-400 text-3xl font-black font-mono">${stat.value}</div>
          <div class="text-gray-300 text-sm font-mono mt-2">${stat.label}</div>
        </div>
      `).join('');

      // Languages chart
      renderLanguagesChart(data.topLanguages);

      // PR list
      renderPRList(data.prs);

      // Organizations
      renderOrganizations(data.organizations);

      // Repositories
      renderRepositories(data.topRepositories);

      // Activity graph
      renderActivityGraph(data.username);

    } catch (error) {
      console.error('Profile load error:', error);
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('error').classList.remove('hidden');
      document.getElementById('error-message').textContent = error.message || 'Failed to load profile. Please check if the username is correct and try again.';
    }
  }



  function renderLanguagesChart(languages) {
    const container = document.getElementById('languages-chart');
    
    if (!languages || languages.length === 0) {
      container.innerHTML = '<p class="text-gray-400 text-center py-4 font-mono text-sm">No language data</p>';
      return;
    }

    const total = languages.reduce((sum, lang) => sum + lang.count, 0);
    const colors = ['bg-blue-500', 'bg-green-500', 'bg-yellow-500', 'bg-purple-500', 'bg-pink-500'];
    
    container.innerHTML = languages.map((lang, i) => {
      const percentage = ((lang.count / total) * 100).toFixed(1);
      return `
        <div>
          <div class="flex justify-between text-sm font-mono mb-1">
            <span class="text-white">${lang.name}</span>
            <span class="text-gray-400">${percentage}%</span>
          </div>
          <div class="w-full bg-gray-700 rounded-full h-2 overflow-hidden">
            <div class="${colors[i % colors.length]} h-full rounded-full" style="width: ${percentage}%"></div>
          </div>
        </div>
      `;
    }).join('');
  }

  function renderPRList(prs) {
    const container = document.getElementById('pr-list');
    
    if (!prs || prs.length === 0) {
      container.innerHTML = `
        <div class="text-center py-8">
          <svg class="w-16 h-16 mx-auto text-gray-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          <p class="text-gray-400 font-mono">No pull requests found</p>
        </div>
      `;
      return;
    }

    container.innerHTML = prs.map(pr => `
      <a 
        href="${pr.html_url}" 
        target="_blank"
        class="block bg-gray-800/50 hover:bg-gray-700/50 rounded-lg p-4 border border-gray-700 hover:border-green-500/50 transition-all group"
      >
        <div class="flex items-start justify-between gap-4">
          <div class="flex-1 min-w-0">
            <h3 class="text-white font-mono text-sm font-semibold mb-1 truncate group-hover:text-green-400 transition-colors">${pr.title}</h3>
            <p class="text-gray-400 text-xs font-mono truncate">${pr.repo}</p>
          </div>
          <span class="flex-shrink-0 px-2.5 py-1 rounded-full text-xs font-mono flex items-center gap-1 ${
            pr.status === 'merged' 
              ? 'bg-purple-500/20 text-purple-400 border border-purple-500/30' 
              : pr.status === 'closed'
              ? 'bg-red-500/20 text-red-400 border border-red-500/30'
              : 'bg-green-500/20 text-green-400 border border-green-500/30'
          }">
            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 16 16">
              ${pr.status === 'merged' 
                ? '<path d="M5 3.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0zm0 2.122a2.25 2.25 0 10-1.5 0v.878A2.25 2.25 0 005.75 8.5h1.5v2.128a2.251 2.251 0 101.5 0V8.5h1.5a2.25 2.25 0 002.25-2.25v-.878a2.25 2.25 0 10-1.5 0v.878a.75.75 0 01-.75.75h-4.5A.75.75 0 015 6.25v-.878zm3.75 7.378a.75.75 0 11-1.5 0 .75.75 0 011.5 0zm3-8.75a.75.75 0 100-1.5.75.75 0 000 1.5z"/>'
                : '<path d="M7.177 3.073L9.573.677A.25.25 0 0110 .854v4.792a.25.25 0 01-.427.177L7.177 3.427a.25.25 0 010-.354zM3.75 2.5a.75.75 0 100 1.5.75.75 0 000-1.5zm-2.25.75a2.25 2.25 0 113 2.122v5.256a2.251 2.251 0 11-1.5 0V5.372A2.25 2.25 0 011.5 3.25zM11 2.5h-1V4h1a1 1 0 011 1v5.628a2.251 2.251 0 101.5 0V5A2.5 2.5 0 0011 2.5zm1 10.25a.75.75 0 111.5 0 .75.75 0 01-1.5 0zM3.75 12a.75.75 0 100 1.5.75.75 0 000-1.5z"/>'
              }
            </svg>
            ${pr.status}
          </span>
        </div>
        <div class="flex items-center gap-4 mt-3 text-xs text-gray-500">
          <span class="flex items-center gap-1.5">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            ${new Date(pr.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
          </span>
          ${pr.language ? `
            <span class="flex items-center gap-1.5">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
              </svg>
              ${pr.language}
            </span>
          ` : ''}
        </div>
      </a>
    `).join('');
  }

  function renderOrganizations(orgs) {
    const container = document.getElementById('organizations-list');
    
    if (!orgs || orgs.length === 0) {
      container.innerHTML = `
        <div class="text-center py-4">
          <svg class="w-12 h-12 mx-auto text-gray-600 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
          </svg>
          <p class="text-gray-400 font-mono text-sm">No organizations</p>
        </div>
      `;
      return;
    }

    container.innerHTML = orgs.map(org => `
      <a 
        href="https://github.com/${org}" 
        target="_blank"
        class="flex items-center gap-3 bg-gray-800/50 hover:bg-gray-700/50 rounded-lg p-3 border border-gray-700 hover:border-green-500/50 transition-all group"
      >
        <div class="relative flex-shrink-0">
          <img src="https://github.com/${org}.png" class="w-10 h-10 rounded-full border-2 border-gray-600 group-hover:border-green-500 transition-colors" alt="${org}" loading="lazy" />
          <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-gray-800 rounded-full flex items-center justify-center">
            <svg class="w-3 h-3 text-green-400" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
          </div>
        </div>
        <div class="flex-1 min-w-0">
          <span class="text-white font-mono text-sm font-medium group-hover:text-green-400 transition-colors truncate block">${org}</span>
          <span class="text-gray-500 text-xs font-mono">Organization</span>
        </div>
        <svg class="w-4 h-4 text-gray-500 group-hover:text-green-400 transition-colors flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
        </svg>
      </a>
    `).join('');
  }

  function renderRepositories(repos) {
    const container = document.getElementById('repositories-list');
    
    if (!repos || repos.length === 0) {
      container.innerHTML = `
        <div class="text-center py-4">
          <svg class="w-12 h-12 mx-auto text-gray-600 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
          </svg>
          <p class="text-gray-400 font-mono text-sm">No repositories</p>
        </div>
      `;
      return;
    }

    container.innerHTML = repos.map(repo => `
      <a 
        href="https://github.com/${repo.name}"
        target="_blank"
        class="block bg-gray-800/50 hover:bg-gray-700/50 rounded-lg p-4 border border-gray-700 hover:border-green-500/50 transition-all group"
      >
        <div class="flex items-start gap-2 mb-3">
          <svg class="w-4 h-4 text-gray-400 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 16 16">
            <path d="M2 2.5A2.5 2.5 0 014.5 0h8.75a.75.75 0 01.75.75v12.5a.75.75 0 01-.75.75h-2.5a.75.75 0 110-1.5h1.75v-2h-8a1 1 0 00-.714 1.7.75.75 0 01-1.072 1.05A2.495 2.495 0 012 11.5v-9zm10.5-1V9h-8c-.356 0-.694.074-1 .208V2.5a1 1 0 011-1h8zM5 12.25v3.25a.25.25 0 00.4.2l1.45-1.087a.25.25 0 01.3 0L8.6 15.7a.25.25 0 00.4-.2v-3.25a.25.25 0 00-.25-.25h-3.5a.25.25 0 00-.25.25z"/>
          </svg>
          <h4 class="text-white font-mono text-sm font-semibold group-hover:text-green-400 transition-colors flex-1 truncate">${(repo.name.split('/')[1]) || repo.name}</h4>
        </div>
        <div class="flex items-center gap-3 text-xs">
          <span class="flex items-center gap-1 text-yellow-400">
            <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
              <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
            </svg>
            <span class="font-mono">${repo.stars || 0}</span>
          </span>
          <span class="flex items-center gap-1 text-gray-400">
            <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 16 16">
              <path d="M5 3.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0zm0 2.122a2.25 2.25 0 10-1.5 0v.878A2.25 2.25 0 005.75 8.5h1.5v2.128a2.251 2.251 0 101.5 0V8.5h1.5a2.25 2.25 0 002.25-2.25v-.878a2.25 2.25 0 10-1.5 0v.878a.75.75 0 01-.75.75h-4.5A.75.75 0 015 6.25v-.878zm3.75 7.378a.75.75 0 11-1.5 0 .75.75 0 011.5 0zm3-8.75a.75.75 0 100-1.5.75.75 0 000 1.5z"/>
            </svg>
            <span class="font-mono">${repo.forks || 0}</span>
          </span>
          ${repo.language ? `
            <span class="flex items-center gap-1 text-blue-400">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
              </svg>
              <span class="font-mono">${repo.language}</span>
            </span>
          ` : ''}
        </div>
      </a>
    `).join('');
  }

  function renderActivityGraph(username) {
    const container = document.getElementById('activity-graph');
    if (!container) return;

    // Clear loading placeholder
    container.innerHTML = '';

    const link = document.createElement('a');
    link.href = 'https://github.com/ashutosh00710/github-readme-activity-graph';
    link.target = '_blank';
    link.rel = 'noopener noreferrer';

    const img = new Image();
    img.alt = `${username}'s GitHub activity graph`;
    img.loading = 'lazy';
    img.referrerPolicy = 'no-referrer';
    img.className = 'w-full';
    img.src = `https://github-readme-activity-graph.vercel.app/graph?username=${encodeURIComponent(username)}&bg_color=165a30&color=0aff54&line=141415&point=fafffc&area=true&hide_border=true`;
    img.onerror = () => {
      container.innerHTML = '<p class="text-gray-400 text-center py-8 font-mono text-sm">Unable to load activity graph right now.</p>';
    };

    link.appendChild(img);
    container.appendChild(link);
  }

  // Load profile on page load
  if (username) {
    loadProfile();
  } else {
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('error').classList.remove('hidden');
    document.getElementById('error-message').textContent = 'No username provided';
  }
</script>

<style>
  /* Custom scrollbar for PR list */
  #pr-list::-webkit-scrollbar {
    width: 8px;
  }

  #pr-list::-webkit-scrollbar-track {
    background: rgba(31, 41, 55, 0.5);
    border-radius: 4px;
  }

  #pr-list::-webkit-scrollbar-thumb {
    background: rgba(34, 197, 94, 0.5);
    border-radius: 4px;
  }

  #pr-list::-webkit-scrollbar-thumb:hover {
    background: rgba(34, 197, 94, 0.7);
  }

  /* Skeleton shimmer animation */
  @keyframes shimmer {
    0% {
      background-position: -1000px 0;
    }
    100% {
      background-position: 1000px 0;
    }
  }

  .skeleton-shimmer {
    animation: shimmer 2s infinite linear;
    background: linear-gradient(
      90deg,
      rgba(31, 41, 55, 0.4) 0%,
      rgba(55, 65, 81, 0.6) 50%,
      rgba(31, 41, 55, 0.4) 100%
    );
    background-size: 1000px 100%;
  }

  /* Custom scrollbar for Repositories list */
  #repositories-list::-webkit-scrollbar {
    width: 6px;
  }

  #repositories-list::-webkit-scrollbar-track {
    background: transparent;
  }

  #repositories-list::-webkit-scrollbar-thumb {
    background-color: #16a34a;
    border-radius: 4px;
  }

  #repositories-list::-webkit-scrollbar-thumb:hover {
    background-color: #15803d;
  }
</style>
